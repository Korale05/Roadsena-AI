{% extends "base.html" %}
{% block title %}Dashboard â€” RoadSense AI{% endblock %}
{% block page_title %}ðŸ“Š Analytics Dashboard{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  .kpi-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:18px; margin-bottom:28px; }
  .kpi-city  { background:linear-gradient(135deg,#1a1a2e,#0f3460); }
  .kpi-total { background:linear-gradient(135deg,#0f3460,#16213e); }
  .kpi-crit  { background:linear-gradient(135deg,#c0392b,#e74c3c); }
  .kpi-eco   { background:linear-gradient(135deg,#d35400,#e67e22); }
  .chart-row { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px; }
  @media(max-width:900px){ .chart-row{ grid-template-columns:1fr; } }
  .chart-card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 2px 12px rgba(0,0,0,.07); }
  .chart-card h6 { font-weight:700; margin-bottom:16px; color:#1a1a2e; }
  .recent-table th { font-size:.78rem; font-weight:700; color:#666; text-transform:uppercase; }
  .recent-table td { font-size:.83rem; vertical-align:middle; }
  .demo-btn { border:2px dashed #e94560; background:transparent; color:#e94560; border-radius:8px;
              padding:10px 22px; font-weight:700; cursor:pointer; transition:.2s; }
  .demo-btn:hover { background:#e94560; color:#fff; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h5 class="mb-1" style="font-weight:800;color:#1a1a2e">Welcome back, {{ officer }} ðŸ‘‹</h5>
    <small class="text-muted">Real-time city road intelligence â€” auto-refreshes every 10 seconds</small>
  </div>
  <div class="d-flex gap-2">
    <button class="demo-btn" onclick="loadDemo()"><i class="fas fa-database me-1"></i>Load Demo Data</button>
    <button class="btn btn-outline-danger btn-sm" onclick="resetData()"><i class="fas fa-trash me-1"></i>Reset</button>
  </div>
</div>

<!-- KPI Cards -->
<div class="kpi-grid" id="kpi-grid">
  <div class="kpi-card kpi-city">
    <div class="kpi-icon"><i class="fas fa-city"></i></div>
    <div class="kpi-lbl">City Health Score</div>
    <div class="kpi-val" id="kpi-hs">â€”</div>
    <small style="opacity:.7">out of 100</small>
  </div>
  <div class="kpi-card kpi-total">
    <div class="kpi-icon"><i class="fas fa-road"></i></div>
    <div class="kpi-lbl">Total Detections</div>
    <div class="kpi-val" id="kpi-total">â€”</div>
    <small style="opacity:.7">all time</small>
  </div>
  <div class="kpi-card kpi-crit">
    <div class="kpi-icon"><i class="fas fa-exclamation-triangle"></i></div>
    <div class="kpi-lbl">Critical Roads</div>
    <div class="kpi-val" id="kpi-crit">â€”</div>
    <small style="opacity:.7">score 6+ (urgent repair)</small>
  </div>
  <div class="kpi-card kpi-eco">
    <div class="kpi-icon"><i class="fas fa-rupee-sign"></i></div>
    <div class="kpi-lbl">Economic Risk (30d)</div>
    <div class="kpi-val" id="kpi-eco">â€”</div>
    <small style="opacity:.7">if roads left unrepaired</small>
  </div>
</div>

<!-- Charts Row -->
<div class="chart-row">
  <div class="chart-card">
    <h6><i class="fas fa-bar-chart me-2 text-danger"></i>Roads by Severity Level</h6>
    <canvas id="sevChart" height="200"></canvas>
  </div>
  <div class="chart-card">
    <h6><i class="fas fa-pie-chart me-2 text-danger"></i>Damage Type Distribution</h6>
    <canvas id="typeChart" height="200"></canvas>
  </div>
</div>

<!-- Recent Inspections -->
<div class="card">
  <div class="card-header d-flex align-items-center justify-content-between py-3 px-4">
    <span><i class="fas fa-clock me-2 text-danger"></i>Recent Inspections</span>
    <a href="/history" class="btn btn-sm btn-outline-secondary">View All</a>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 recent-table">
        <thead class="table-light">
          <tr>
            <th class="px-4 py-3">Road</th>
            <th>Score</th>
            <th>Level</th>
            <th>Defects</th>
            <th>Source</th>
            <th>Economic Risk</th>
            <th>Time</th>
            <th>PDF</th>
          </tr>
        </thead>
        <tbody id="recent-tbody">
          <tr><td colspan="8" class="text-center py-4 text-muted">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let sevChart, typeChart;

const SEV_COLORS = {
  Good:"#28a745", Moderate:"#ffc107", Severe:"#fd7e14", Critical:"#dc3545", Emergency:"#7b0000"
};
const TYPE_COLORS = ["#e94560","#0f3460","#f5a623","#28a745","#9b59b6"];

function initCharts(){
  sevChart = new Chart(document.getElementById("sevChart"),{
    type:"bar",
    data:{ labels:["Good","Moderate","Severe","Critical","Emergency"],
           datasets:[{label:"Roads", data:[0,0,0,0,0],
             backgroundColor:Object.values(SEV_COLORS), borderRadius:6 }] },
    options:{ responsive:true, plugins:{legend:{display:false}},
              scales:{ y:{ beginAtZero:true, ticks:{stepSize:1} } } }
  });
  typeChart = new Chart(document.getElementById("typeChart"),{
    type:"doughnut",
    data:{ labels:[], datasets:[{data:[], backgroundColor:TYPE_COLORS}] },
    options:{ responsive:true, plugins:{legend:{position:"bottom"}} }
  });
}

function updateDashboard(){
  fetch("/api/stats").then(r=>r.json()).then(d=>{
    // KPIs
    document.getElementById("kpi-hs").textContent    = d.city_health + "/100";
    document.getElementById("kpi-total").textContent  = d.total;
    document.getElementById("kpi-crit").textContent   = d.critical;
    const eco = d.economic_risk;
    document.getElementById("kpi-eco").textContent   = eco>=10000000
      ? "â‚¹"+( eco/10000000).toFixed(1)+"Cr"
      : eco>=100000
      ? "â‚¹"+(eco/100000).toFixed(1)+"L"
      : "â‚¹"+eco.toLocaleString("en-IN");

    // Severity chart
    const sd = d.severity_dist || {};
    sevChart.data.datasets[0].data = ["Good","Moderate","Severe","Critical","Emergency"].map(k=>sd[k]||0);
    sevChart.update();

    // Type chart
    const td = d.damage_types || {};
    typeChart.data.labels   = Object.keys(td);
    typeChart.data.datasets[0].data = Object.values(td);
    typeChart.update();

    // Recent table
    const tbody = document.getElementById("recent-tbody");
    if(!d.recent || d.recent.length===0){
      tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No detections yet. Start a live inspection or load demo data.</td></tr>';
      return;
    }
    tbody.innerHTML = d.recent.map(r=>{
      const ts = r.timestamp.replace("T"," ").substring(0,16);
      const eco = r.economic_impact>=100000?"â‚¹"+(r.economic_impact/100000).toFixed(1)+"L":"â‚¹"+r.economic_impact.toLocaleString("en-IN");
      const badge = `<span class="score-badge sev-${r.level.toLowerCase()}">${r.score}/10</span>`;
      const n_det = (r.detections||[]).length;
      return `<tr class="fade-in">
        <td class="px-4"><strong>${r.road_name}</strong></td>
        <td>${badge}</td>
        <td>${r.level}</td>
        <td>${n_det}</td>
        <td><span class="badge bg-secondary">${r.source||''}</span></td>
        <td>${eco}</td>
        <td class="text-muted">${ts}</td>
        <td><a href="/api/report/${r.id}" class="btn btn-xs btn-outline-danger btn-sm py-0 px-2"><i class="fas fa-file-pdf"></i></a></td>
      </tr>`;
    }).join("");
  }).catch(err=>console.error(err));
}

function loadDemo(){
  fetch("/api/add-demo-data",{method:"POST"}).then(r=>r.json()).then(d=>{
    if(d.ok){ updateDashboard(); showToast(`âœ… ${d.added} demo records added!`); }
  });
}
function resetData(){
  if(!confirm("Delete all detection data?")) return;
  fetch("/api/reset",{method:"POST"}).then(()=>{ updateDashboard(); showToast("ðŸ—‘ Data reset."); });
}
function showToast(msg){
  const t = document.createElement("div");
  t.style.cssText = "position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#1a1a2e;color:#fff;padding:10px 22px;border-radius:24px;font-size:.85rem;z-index:99999;box-shadow:0 4px 16px rgba(0,0,0,.3)";
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 3000);
}

initCharts();
updateDashboard();
setInterval(updateDashboard, 10000);
</script>
{% endblock %}