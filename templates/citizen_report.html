<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Report a Pothole â€” RoadSense AI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    body { background:linear-gradient(135deg,#0d0d1a,#1a1a2e); min-height:100vh; font-family:'Segoe UI',sans-serif; padding:20px; }
    .report-card { max-width:500px; margin:0 auto; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:18px; padding:32px; color:#fff; }
    .brand { text-align:center; margin-bottom:28px; }
    .brand h3 { font-weight:800; color:#fff; }
    .brand h3 span { color:#e94560; }
    .brand p { color:rgba(255,255,255,.5); font-size:.84rem; margin:4px 0 0; }

    .upload-zone {
      border:2px dashed rgba(255,255,255,.2); border-radius:12px;
      padding:36px 20px; text-align:center; cursor:pointer; transition:.2s;
      background:rgba(255,255,255,.03);
    }
    .upload-zone:hover, .upload-zone.drag-over { border-color:#e94560; background:rgba(233,69,96,.08); }
    .upload-zone.has-file { border-color:#28a745; background:rgba(40,167,69,.06); }
    .upload-zone i { font-size:2.5rem; color:rgba(255,255,255,.25); margin-bottom:10px; }
    #preview-img { width:100%; border-radius:10px; margin-top:14px; display:none; }

    .form-label { color:rgba(255,255,255,.65); font-size:.8rem; }
    .form-control, .form-select {
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
      color:#fff; border-radius:8px;
    }
    .form-control:focus, .form-select:focus { background:rgba(255,255,255,.12); border-color:#e94560; color:#fff; box-shadow:none; }
    .form-control::placeholder { color:rgba(255,255,255,.3); }
    option { background:#1a1a2e; color:#fff; }

    .btn-submit { background:linear-gradient(135deg,#e94560,#c0392b); color:#fff; border:none; width:100%; padding:13px; border-radius:10px; font-weight:700; font-size:1rem; transition:.2s; }
    .btn-submit:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(233,69,96,.4); }
    .btn-submit:disabled { opacity:.6; transform:none; }

    .result-card { background:rgba(255,255,255,.07); border-radius:12px; padding:20px; margin-top:20px; display:none; }
    .result-score { font-size:3rem; font-weight:900; line-height:1; }
    .result-level { font-size:1.1rem; font-weight:700; margin-top:4px; }
    .det-chip { display:inline-block; padding:4px 12px; border-radius:20px; font-size:.75rem; margin:2px; font-weight:600; }
    #gps-status { font-size:.72rem; color:rgba(255,255,255,.4); margin-top:4px; }
    .official-link { text-align:center; margin-top:20px; }
    .official-link a { color:rgba(255,255,255,.35); font-size:.76rem; text-decoration:none; }
    .official-link a:hover { color:#e94560; }
  </style>
</head>
<body>
<div class="report-card">
  <div class="brand">
    <h3>ðŸ›£ Road<span>Sense</span></h3>
    <p>Report a pothole or road damage in your city</p>
    <p style="font-size:.72rem;color:rgba(255,255,255,.3)">No login required Â· AI analyzes instantly Â· Report is registered</p>
  </div>

  <div id="upload-zone" class="upload-zone mb-3"
       onclick="document.getElementById('img-input').click()"
       ondragover="event.preventDefault();this.classList.add('drag-over')"
       ondragleave="this.classList.remove('drag-over')"
       ondrop="handleDrop(event)">
    <i class="fas fa-camera" id="upload-icon"></i>
    <p id="upload-text" style="color:rgba(255,255,255,.5);margin:0;font-size:.85rem">Tap to take photo or upload from gallery</p>
    <img id="preview-img" alt="Preview"/>
  </div>
  <input type="file" id="img-input" accept="image/*" capture="environment" style="display:none" onchange="fileSelected(this)"/>

  <div class="mb-3">
    <label class="form-label"><i class="fas fa-road me-1"></i>Road Name / Location</label>
    <input type="text" id="road-name" class="form-control" placeholder="e.g. MG Road near bus stand"/>
  </div>

  <div class="row g-2 mb-3">
    <div class="col-6">
      <label class="form-label"><i class="fas fa-map-marker-alt me-1"></i>Latitude</label>
      <input type="number" id="lat-input" class="form-control" step="any" placeholder="Auto-detect"/>
    </div>
    <div class="col-6">
      <label class="form-label"><i class="fas fa-map-marker-alt me-1"></i>Longitude</label>
      <input type="number" id="lng-input" class="form-control" step="any" placeholder="Auto-detect"/>
    </div>
  </div>
  <p id="gps-status"><i class="fas fa-location-dot me-1"></i>Detecting locationâ€¦</p>

  <button class="btn-submit mt-2" id="submit-btn" onclick="submitReport()" disabled>
    <i class="fas fa-paper-plane me-2"></i>Submit Report
  </button>

  <!-- Result -->
  <div class="result-card" id="result-card">
    <div class="text-center mb-3">
      <div class="result-score" id="result-score" style="color:#e94560">â€”</div>
      <div class="result-level" id="result-level">â€”</div>
      <div style="font-size:.8rem;color:rgba(255,255,255,.5);margin-top:4px" id="result-action">â€”</div>
    </div>
    <div id="result-chips" class="mb-3" style="text-align:center"></div>
    <img id="result-img" style="width:100%;border-radius:8px;display:none" alt="Annotated"/>
    <div class="mt-3 p-2 rounded" style="background:rgba(40,167,69,.15);text-align:center;font-size:.78rem;color:#28a745">
      âœ… Your report has been registered in the municipal database. Thank you!
    </div>
  </div>

  <div class="official-link">
    <a href="/login">Municipal Officer Login â†’</a>
  </div>
</div>

<script>
let selectedFile = null;

// Auto GPS
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    document.getElementById("lat-input").value = pos.coords.latitude.toFixed(6);
    document.getElementById("lng-input").value = pos.coords.longitude.toFixed(6);
    document.getElementById("gps-status").innerHTML =
      `<i class="fas fa-check-circle text-success me-1"></i>Location detected: ${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
  }, ()=>{
    document.getElementById("gps-status").textContent = "âš ï¸ Location unavailable â€” enter manually.";
  });
}

function fileSelected(input){
  const file = input.files[0];
  if(!file) return;
  selectedFile = file;
  const reader = new FileReader();
  reader.onload = e=>{
    const preview = document.getElementById("preview-img");
    preview.src = e.target.result;
    preview.style.display = "block";
    const zone = document.getElementById("upload-zone");
    zone.classList.add("has-file");
    document.getElementById("upload-icon").className = "fas fa-check-circle";
    document.getElementById("upload-icon").style.color = "#28a745";
    document.getElementById("upload-text").textContent = file.name;
    document.getElementById("submit-btn").disabled = false;
  };
  reader.readAsDataURL(file);
}

function handleDrop(e){
  e.preventDefault();
  document.getElementById("upload-zone").classList.remove("drag-over");
  const dt = e.dataTransfer;
  if(dt.files[0]){
    document.getElementById("img-input").files = dt.files;
    fileSelected({files:dt.files});
  }
}

function submitReport(){
  if(!selectedFile){ alert("Please select a photo."); return; }
  const road = document.getElementById("road-name").value || "Unknown Road";
  const lat  = parseFloat(document.getElementById("lat-input").value)  || 17.6868;
  const lng  = parseFloat(document.getElementById("lng-input").value)  || 75.9079;

  const btn = document.getElementById("submit-btn");
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzingâ€¦';

  const formData = new FormData();
  formData.append("image", selectedFile);
  formData.append("road_name", road);
  formData.append("lat", lat);
  formData.append("lng", lng);

  fetch("/api/upload-image",{method:"POST", body:formData})
    .then(r=>r.json()).then(d=>{
      btn.innerHTML = '<i class="fas fa-check me-2"></i>Submitted!';
      showResult(d);
    }).catch(err=>{
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Submit Report';
      alert("Error: "+err.message);
    });
}

function showResult(d){
  const card = document.getElementById("result-card");
  card.style.display = "block";

  const score = d.score||0;
  document.getElementById("result-score").textContent = score+"/10";
  document.getElementById("result-level").textContent = d.level||"Unknown";
  document.getElementById("result-action").textContent = d.repair_action||"";

  // Color
  const colors = {Good:"#28a745",Moderate:"#ffc107",Severe:"#fd7e14",Critical:"#dc3545",Emergency:"#7b0000"};
  document.getElementById("result-score").style.color = d.color||colors[d.level]||"#e94560";

  // Chips
  const chips = (d.detections||[]).map(det=>
    `<span class="det-chip" style="background:${d.color};color:#fff">${det.label||det.class}</span>`
  ).join("");
  document.getElementById("result-chips").innerHTML = chips||'<span style="color:rgba(255,255,255,.5);font-size:.8rem">No defects detected</span>';

  // Image
  if(d.img_url){
    const img = document.getElementById("result-img");
    img.src = d.img_url;
    img.style.display = "block";
  }

  card.scrollIntoView({behavior:"smooth"});
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
</body>
</html>