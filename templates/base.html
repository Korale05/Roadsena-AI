<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}RoadSense AI{% endblock %}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --rs-dark:   #0d0d1a;
      --rs-navy:   #1a1a2e;
      --rs-blue:   #16213e;
      --rs-accent: #0f3460;
      --rs-red:    #e94560;
      --rs-gold:   #f5a623;
      --rs-green:  #28a745;
      --sidebar-w: 240px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; color: #333; min-height:100vh; }

    /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      position: fixed; top: 0; left: 0; width: var(--sidebar-w);
      height: 100vh; background: var(--rs-navy);
      display: flex; flex-direction: column;
      box-shadow: 3px 0 15px rgba(0,0,0,.35); z-index: 1000;
    }
    .sidebar-brand {
      padding: 22px 20px; border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .sidebar-brand h4 { color: #fff; font-weight: 800; font-size: 1.2rem; margin-bottom: 2px; }
    .sidebar-brand h4 span { color: var(--rs-red); }
    .sidebar-brand small { color: rgba(255,255,255,.45); font-size: 0.7rem; }

    .sidebar-menu { flex: 1; overflow-y: auto; padding: 10px 0; }
    .nav-section-label {
      padding: 14px 20px 6px; font-size: 0.65rem; font-weight: 700;
      color: rgba(255,255,255,.3); text-transform: uppercase; letter-spacing: 1.5px;
    }
    .sidebar-menu a {
      display: flex; align-items: center; gap: 12px;
      padding: 11px 20px; color: rgba(255,255,255,.65);
      text-decoration: none; font-size: 0.88rem; transition: all .2s;
      border-left: 3px solid transparent;
    }
    .sidebar-menu a:hover, .sidebar-menu a.active {
      background: rgba(255,255,255,.07);
      color: #fff;
      border-left-color: var(--rs-red);
    }
    .sidebar-menu a i { width: 18px; text-align: center; font-size: 0.9rem; }

    .sidebar-footer {
      padding: 14px 20px; border-top: 1px solid rgba(255,255,255,.08);
      font-size: 0.78rem; color: rgba(255,255,255,.4);
    }
    .sidebar-footer a { color: var(--rs-red); text-decoration: none; }

    /* â”€â”€ Topbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .topbar {
      position: fixed; top: 0; left: var(--sidebar-w);
      right: 0; height: 58px;
      background: #fff; border-bottom: 1px solid #e0e0e0;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 28px; z-index: 999;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    .topbar .page-title { font-weight: 700; font-size: 1.05rem; color: var(--rs-navy); }
    .topbar .officer-badge {
      display: flex; align-items: center; gap: 10px;
    }
    .officer-avatar {
      width: 34px; height: 34px; border-radius: 50%;
      background: var(--rs-accent); color: #fff;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.85rem;
    }

    /* â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main-content {
      margin-left: var(--sidebar-w); margin-top: 58px;
      padding: 28px; min-height: calc(100vh - 58px);
    }

    /* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.07); }
    .card-header { border-bottom: 1px solid rgba(0,0,0,.06); background: transparent; font-weight: 700; }

    /* â”€â”€ KPI Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .kpi-card {
      border-radius: 12px; padding: 20px 24px;
      color: #fff; position: relative; overflow: hidden;
    }
    .kpi-card .kpi-icon {
      position: absolute; right: 18px; top: 16px;
      font-size: 2.8rem; opacity: .15;
    }
    .kpi-card .kpi-val { font-size: 2rem; font-weight: 800; margin: 4px 0; }
    .kpi-card .kpi-lbl { font-size: 0.78rem; opacity: .85; }

    /* â”€â”€ Score Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .score-badge {
      display: inline-block; padding: 3px 10px; border-radius: 20px;
      font-weight: 700; font-size: 0.8rem; color: #fff;
    }

    /* â”€â”€ Severity Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sev-good      { background: #28a745; }
    .sev-moderate  { background: #ffc107; color:#333!important; }
    .sev-severe    { background: #fd7e14; }
    .sev-critical  { background: #dc3545; }
    .sev-emergency { background: #7b0000; }

    /* â”€â”€ Chat Widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #chat-widget {
      position: fixed; bottom: 24px; right: 24px; z-index: 9999;
    }
    #chat-btn {
      width: 54px; height: 54px; border-radius: 50%;
      background: var(--rs-red); color: #fff; border: none;
      font-size: 1.4rem; cursor: pointer; box-shadow: 0 4px 18px rgba(233,69,96,.45);
      transition: transform .2s;
    }
    #chat-btn:hover { transform: scale(1.08); }
    #chat-box {
      display: none; position: fixed; bottom: 90px; right: 24px;
      width: 340px; background: #fff; border-radius: 14px;
      box-shadow: 0 8px 32px rgba(0,0,0,.18); overflow: hidden;
    }
    #chat-box .chat-header {
      background: var(--rs-navy); color: #fff;
      padding: 14px 18px; font-weight: 700; font-size: 0.9rem;
      display: flex; align-items: center; gap: 8px;
    }
    #chat-messages {
      height: 280px; overflow-y: auto; padding: 14px;
      display: flex; flex-direction: column; gap: 10px;
    }
    .chat-msg { padding: 8px 12px; border-radius: 10px; font-size: 0.83rem; max-width: 90%; }
    .chat-msg.user { background: var(--rs-accent); color: #fff; align-self: flex-end; }
    .chat-msg.bot  { background: #f0f2f5; color: #333; align-self: flex-start; }
    #chat-input-row { display: flex; border-top: 1px solid #eee; }
    #chat-input {
      flex: 1; border: none; padding: 12px 14px; font-size: 0.85rem; outline: none;
    }
    #chat-send, #chat-mic {
      border: none; padding: 0 14px; cursor: pointer;
      background: transparent; font-size: 1.1rem;
    }
    #chat-send { color: var(--rs-red); }
    #chat-mic  { color: var(--rs-accent); }

    /* â”€â”€ Misc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pulse { animation: pulse-anim 1.5s infinite; }
    @keyframes pulse-anim {
      0%, 100% { opacity:1; } 50% { opacity:.4; }
    }
    .fade-in { animation: fadeIn .4s ease; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:none; } }
  </style>
  {% block head %}{% endblock %}
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-brand">
    <h4>ðŸ›£ Road<span>Sense</span> AI</h4>
    <small>Municipal Road Intelligence</small>
  </div>
  <div class="sidebar-menu">
    <div class="nav-section-label">Overview</div>
    <a href="/dashboard"    class="{% if request.path=='/dashboard'    %}active{% endif %}"><i class="fas fa-chart-pie"></i> Dashboard</a>
    <a href="/city-map"     class="{% if request.path=='/city-map'     %}active{% endif %}"><i class="fas fa-map"></i> City Map</a>
    <div class="nav-section-label">Inspection</div>
    <a href="/live-inspection" class="{% if request.path=='/live-inspection' %}active{% endif %}"><i class="fas fa-video"></i> Live Inspection</a>
    <a href="/video-upload"    class="{% if request.path=='/video-upload'    %}active{% endif %}"><i class="fas fa-film"></i> Video Upload</a>
    <div class="nav-section-label">Management</div>
    <a href="/repair-queue" class="{% if request.path=='/repair-queue' %}active{% endif %}"><i class="fas fa-list-ol"></i> Repair Queue</a>
    <a href="/history"      class="{% if request.path=='/history'      %}active{% endif %}"><i class="fas fa-history"></i> History</a>
    <div class="nav-section-label">Public</div>
    <a href="/report" target="_blank"><i class="fas fa-users"></i> Citizen Report</a>
  </div>
  <div class="sidebar-footer">
    <i class="fas fa-user-circle me-1"></i> {{ officer }} &nbsp;|&nbsp;
    <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>
</div>

<!-- Topbar -->
<div class="topbar">
  <span class="page-title">{% block page_title %}Dashboard{% endblock %}</span>
  <div class="officer-badge">
    <span id="city-health-topbar" style="font-size:.8rem;color:#666;">City Score: â€”</span>
    <div class="officer-avatar">{{ (officer or 'O')[0].upper() }}</div>
  </div>
</div>

<!-- Main Content -->
<div class="main-content">
  {% block content %}{% endblock %}
</div>

<!-- AI Chat Widget -->
<div id="chat-widget">
  <button id="chat-btn" onclick="toggleChat()" title="AI Assistant"><i class="fas fa-robot"></i></button>
</div>
<div id="chat-box">
  <div class="chat-header">
    <i class="fas fa-robot"></i> RoadSense AI Agent
    <button onclick="toggleChat()" style="margin-left:auto;background:none;border:none;color:#fff;cursor:pointer;font-size:1rem;"><i class="fas fa-times"></i></button>
  </div>
  <div id="chat-messages">
    <div class="chat-msg bot">ðŸ‘‹ Hi! I'm your AI road assistant. Ask me: <em>"Which road to fix first?"</em> or <em>"What is the city health score?"</em></div>
  </div>
  <div id="chat-input-row">
    <button id="chat-mic" onclick="startVoice()" title="Voice Input"><i class="fas fa-microphone"></i></button>
    <input id="chat-input" placeholder="Ask anything about roadsâ€¦" onkeydown="if(event.key==='Enter')sendChat()"/>
    <button id="chat-send" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script>
  // â”€â”€ City Health in Topbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fetch("/api/city-health-score").then(r=>r.json()).then(d=>{
    const el = document.getElementById("city-health-topbar");
    const s  = d.score;
    const color = s>=70?"#28a745":s>=50?"#fd7e14":"#dc3545";
    el.innerHTML = `City Score: <strong style="color:${color}">${s}/100</strong>`;
  }).catch(()=>{});

  // â”€â”€ Chat Widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleChat(){
    const box = document.getElementById("chat-box");
    box.style.display = box.style.display==="block"?"none":"block";
  }
  function appendMsg(text, role){
    const el = document.createElement("div");
    el.className = `chat-msg ${role}`;
    el.textContent = text;
    const msgs = document.getElementById("chat-messages");
    msgs.appendChild(el);
    msgs.scrollTop = msgs.scrollHeight;
  }
  function sendChat(){
    const inp = document.getElementById("chat-input");
    const msg = inp.value.trim();
    if(!msg) return;
    inp.value = "";
    appendMsg(msg, "user");
    appendMsg("â³ Thinkingâ€¦", "bot");
    fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg})})
      .then(r=>r.json()).then(d=>{
        const msgs = document.getElementById("chat-messages");
        msgs.removeChild(msgs.lastChild);
        appendMsg(d.reply, "bot");
      }).catch(()=>{
        const msgs = document.getElementById("chat-messages");
        msgs.removeChild(msgs.lastChild);
        appendMsg("Sorry, AI agent is unavailable right now.", "bot");
      });
  }
  function startVoice(){
    if(!("webkitSpeechRecognition" in window)){
      alert("Voice input not supported in this browser. Try Chrome."); return;
    }
    const rec = new webkitSpeechRecognition();
    rec.lang = "en-IN";
    rec.onresult = e=>{
      document.getElementById("chat-input").value = e.results[0][0].transcript;
      sendChat();
    };
    rec.start();
    document.getElementById("chat-mic").innerHTML = '<i class="fas fa-circle pulse" style="color:red"></i>';
    rec.onend = ()=>{ document.getElementById("chat-mic").innerHTML = '<i class="fas fa-microphone"></i>'; };
  }
</script>
{% block scripts %}{% endblock %}
</body>
</html>