{% extends "base.html" %}
{% block title %}City Intelligence Map â€” RoadSense AI{% endblock %}
{% block page_title %}ğŸ—º City Intelligence Map{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<style>
/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.map-page { display:flex; gap:0; height:calc(100vh - 120px); border-radius:16px; overflow:hidden; box-shadow:0 8px 40px rgba(0,0,0,.18); }

/* â”€â”€ Left Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.map-panel {
  width:320px; min-width:320px; background:#fff;
  display:flex; flex-direction:column; border-right:1px solid #e8e8e8;
  transition: width .3s;
}
.map-panel.collapsed { width:0; min-width:0; overflow:hidden; }

.panel-header {
  background:linear-gradient(135deg,#1a1a2e,#0f3460);
  padding:16px 18px; color:#fff; flex-shrink:0;
}
.panel-header h6 { margin:0; font-weight:800; font-size:.95rem; letter-spacing:.3px; }
.panel-header small { color:rgba(255,255,255,.45); font-size:.72rem; }

/* City Score Bar */
.city-score-bar {
  padding:14px 16px; background:#f8f9fa; border-bottom:1px solid #eee; flex-shrink:0;
}
.score-ring-wrap { display:flex; align-items:center; gap:14px; }
.score-ring { width:56px; height:56px; flex-shrink:0; }
.score-ring circle { fill:none; stroke-width:6; }
.score-ring .track { stroke:#e0e0e0; }
.score-ring .fill  { stroke-linecap:round; transform:rotate(-90deg); transform-origin:50% 50%; transition:stroke-dashoffset .8s; }
.score-ring .num   { font-size:13px; font-weight:900; dominant-baseline:middle; text-anchor:middle; }
.score-stats { display:grid; grid-template-columns:1fr 1fr; gap:6px; flex:1; }
.ss-box { background:#fff; border-radius:8px; padding:6px 10px; border:1px solid #eee; text-align:center; }
.ss-box .sv { font-size:1.1rem; font-weight:800; color:#1a1a2e; }
.ss-box .sl { font-size:.65rem; color:#aaa; }

/* Filters */
.filter-section { padding:10px 14px; border-bottom:1px solid #eee; flex-shrink:0; }
.filter-section label { font-size:.68rem; font-weight:700; color:#aaa; text-transform:uppercase; margin-bottom:6px; display:block; }
.filter-chips { display:flex; flex-wrap:wrap; gap:4px; margin-bottom:8px; }
.fchip {
  font-size:.68rem; padding:3px 10px; border-radius:20px; border:none;
  cursor:pointer; font-weight:700; transition:.15s; opacity:.65;
}
.fchip.active { opacity:1; transform:scale(1.05); box-shadow:0 2px 8px rgba(0,0,0,.2); }
.search-box { position:relative; }
.search-box input {
  width:100%; border:1px solid #e0e0e0; border-radius:8px;
  padding:7px 30px 7px 10px; font-size:.8rem; outline:none;
  transition:border-color .2s;
}
.search-box input:focus { border-color:#0f3460; }
.search-box i { position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#aaa; font-size:.75rem; }

/* Road List */
.road-list-wrap { flex:1; overflow-y:auto; }
.road-item {
  padding:11px 14px; border-bottom:1px solid #f5f5f5;
  cursor:pointer; transition:.15s; display:flex; align-items:center; gap:10px;
}
.road-item:hover { background:#f8f9fa; transform:translateX(3px); }
.road-item.active-item { background:#f0f4ff; border-left:3px solid #0f3460; }
.ri-score {
  width:40px; height:40px; border-radius:10px; display:flex; align-items:center;
  justify-content:center; font-weight:900; font-size:.9rem; color:#fff; flex-shrink:0;
}
.ri-info { flex:1; min-width:0; }
.ri-name { font-weight:700; font-size:.83rem; color:#1a1a2e; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.ri-meta { font-size:.7rem; color:#aaa; margin-top:2px; }
.ri-eco  { font-size:.68rem; color:#e94560; font-weight:700; }
.ri-badge { font-size:.6rem; padding:2px 7px; border-radius:10px; color:#fff; font-weight:700; white-space:nowrap; }

/* â”€â”€ Map Wrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.map-wrap { flex:1; position:relative; }
#map { width:100%; height:100%; }

/* â”€â”€ Floating Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.map-fab-group {
  position:absolute; top:14px; right:14px; z-index:1000;
  display:flex; flex-direction:column; gap:6px;
}
.map-fab {
  background:#fff; border:none; width:38px; height:38px; border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 2px 10px rgba(0,0,0,.2); cursor:pointer; font-size:.9rem;
  transition:.2s; color:#1a1a2e;
}
.map-fab:hover { background:#1a1a2e; color:#fff; transform:scale(1.08); }
.map-fab.active { background:#e94560; color:#fff; }
.map-fab-label { position:absolute; right:48px; top:50%; transform:translateY(-50%); background:#1a1a2e; color:#fff; padding:3px 10px; border-radius:6px; font-size:.7rem; white-space:nowrap; pointer-events:none; opacity:0; transition:.2s; }
.map-fab:hover .map-fab-label { opacity:1; }

/* View toggle bar */
.view-toggle {
  position:absolute; top:14px; left:14px; z-index:1000;
  background:#fff; border-radius:10px; overflow:hidden;
  box-shadow:0 2px 10px rgba(0,0,0,.15); display:flex;
}
.vt-btn {
  border:none; padding:8px 14px; font-size:.75rem; font-weight:700;
  cursor:pointer; background:transparent; color:#888; transition:.2s;
}
.vt-btn.active { background:#1a1a2e; color:#fff; }

/* Live indicator */
.live-pill {
  position:absolute; bottom:14px; left:14px; z-index:1000;
  background:rgba(13,13,26,.85); color:#fff; padding:6px 14px;
  border-radius:20px; font-size:.72rem; backdrop-filter:blur(8px);
  display:flex; align-items:center; gap:6px;
}
.live-dot { width:7px; height:7px; border-radius:50%; background:#28a745; animation:pulse-anim 1.5s infinite; }

/* Stats strip at bottom */
.stats-strip {
  position:absolute; bottom:14px; right:14px; z-index:1000;
  display:flex; gap:8px;
}
.stat-pill {
  background:rgba(13,13,26,.85); color:#fff; padding:6px 12px;
  border-radius:20px; font-size:.72rem; backdrop-filter:blur(8px);
  text-align:center;
}
.stat-pill .sp-val { font-weight:800; font-size:.9rem; }
.stat-pill .sp-lbl { color:rgba(255,255,255,.5); font-size:.62rem; }

/* â”€â”€ Panel Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-toggle {
  position:absolute; top:50%; left:320px; transform:translateY(-50%);
  z-index:1001; background:#fff; border:none; width:20px; height:50px;
  border-radius:0 8px 8px 0; cursor:pointer; box-shadow:2px 0 8px rgba(0,0,0,.1);
  color:#888; font-size:.7rem; transition:.3s; display:flex; align-items:center; justify-content:center;
}
.panel-toggle.collapsed { left:0; }

/* â”€â”€ Popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rs-popup { min-width:240px; max-width:300px; font-family:'Segoe UI',sans-serif; }
.rs-popup .pop-header { background:linear-gradient(135deg,#1a1a2e,#0f3460); color:#fff; padding:12px 14px; margin:-14px -20px 12px; border-radius:6px 6px 0 0; }
.rs-popup .pop-road { font-weight:800; font-size:.95rem; margin-bottom:3px; }
.rs-popup .pop-score { display:inline-block; padding:2px 10px; border-radius:20px; font-size:.75rem; font-weight:700; }
.rs-popup .pop-row { display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #f0f0f0; font-size:.78rem; }
.rs-popup .pop-row:last-of-type { border:none; }
.rs-popup .pop-key { color:#888; }
.rs-popup .pop-val { font-weight:700; color:#1a1a2e; text-align:right; max-width:60%; }
.rs-popup .pop-img { width:100%; border-radius:6px; margin:10px 0 6px; display:block; }
.rs-popup .pop-types { margin:8px 0; }
.rs-popup .pop-type-chip { display:inline-block; padding:2px 8px; border-radius:12px; font-size:.68rem; font-weight:700; color:#fff; margin:2px; }
.rs-popup .pop-actions { display:flex; gap:6px; margin-top:10px; }
.rs-popup .pop-btn { flex:1; text-align:center; padding:6px; border-radius:6px; text-decoration:none; font-size:.72rem; font-weight:700; cursor:pointer; border:none; }

/* â”€â”€ Route Playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.route-panel {
  position:absolute; bottom:60px; left:50%; transform:translateX(-50%);
  z-index:1000; background:rgba(13,13,26,.92); color:#fff;
  padding:10px 20px; border-radius:30px; backdrop-filter:blur(10px);
  display:none; align-items:center; gap:12px; font-size:.8rem;
  box-shadow:0 4px 20px rgba(0,0,0,.3);
}
.route-panel.show { display:flex; }
.rp-btn { background:rgba(255,255,255,.12); border:none; color:#fff; width:30px; height:30px; border-radius:50%; cursor:pointer; font-size:.9rem; transition:.2s; }
.rp-btn:hover { background:rgba(255,255,255,.25); }

/* â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.map-legend {
  position:absolute; bottom:60px; right:14px; z-index:1000;
  background:rgba(13,13,26,.88); color:#fff; padding:12px 16px;
  border-radius:12px; backdrop-filter:blur(8px); font-size:.72rem;
  display:none;
}
.map-legend.show { display:block; }
.legend-row { display:flex; align-items:center; gap:8px; margin:5px 0; }
.legend-dot { width:12px; height:12px; border-radius:50%; }

/* Scrollbar */
.road-list-wrap::-webkit-scrollbar { width:4px; }
.road-list-wrap::-webkit-scrollbar-track { background:#f0f0f0; }
.road-list-wrap::-webkit-scrollbar-thumb { background:#ccc; border-radius:2px; }
</style>
{% endblock %}

{% block content %}
<div style="position:relative;margin:-28px;height:calc(100vh - 58px);">

<!-- Panel Toggle -->
<button class="panel-toggle" id="panel-toggle" onclick="togglePanel()" title="Toggle sidebar">
  <i class="fas fa-chevron-left" id="panel-toggle-icon"></i>
</button>

<div class="map-page" id="map-page">

  <!-- â”€â”€ Left Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="map-panel" id="map-panel">
    <div class="panel-header">
      <h6><i class="fas fa-map me-2"></i>City Intelligence Map</h6>
      <small id="last-update-text">Updating every 15 seconds</small>
    </div>

    <!-- City Health Score -->
    <div class="city-score-bar">
      <div class="score-ring-wrap">
        <svg class="score-ring" viewBox="0 0 56 56">
          <circle class="track" cx="28" cy="28" r="22"/>
          <circle class="fill" id="score-ring-fill" cx="28" cy="28" r="22"
            stroke="#28a745" stroke-dasharray="138.2" stroke-dashoffset="138.2"/>
          <text class="num" id="score-ring-num" x="28" y="29" fill="#1a1a2e">â€”</text>
        </svg>
        <div class="score-stats">
          <div class="ss-box"><div class="sv" id="ss-total">0</div><div class="sl">Roads</div></div>
          <div class="ss-box"><div class="sv" id="ss-crit" style="color:#dc3545">0</div><div class="sl">Critical</div></div>
          <div class="ss-box"><div class="sv" id="ss-emerg" style="color:#7b0000">0</div><div class="sl">Emergency</div></div>
          <div class="ss-box"><div class="sv" id="ss-eco" style="color:#e94560">â€”</div><div class="sl">Eco Risk</div></div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filter-section">
      <label>Filter by severity</label>
      <div class="filter-chips">
        <button class="fchip active" data-level="" style="background:#1a1a2e;color:#fff" onclick="setFilter(this,'')">All</button>
        <button class="fchip" data-level="Emergency" style="background:#7b0000;color:#fff" onclick="setFilter(this,'Emergency')">Emergency</button>
        <button class="fchip" data-level="Critical"  style="background:#dc3545;color:#fff" onclick="setFilter(this,'Critical')">Critical</button>
        <button class="fchip" data-level="Severe"    style="background:#fd7e14;color:#fff" onclick="setFilter(this,'Severe')">Severe</button>
        <button class="fchip" data-level="Moderate"  style="background:#ffc107;color:#333" onclick="setFilter(this,'Moderate')">Moderate</button>
        <button class="fchip" data-level="Good"      style="background:#28a745;color:#fff" onclick="setFilter(this,'Good')">Good</button>
      </div>
      <div class="search-box">
        <input type="text" id="road-search" placeholder="Search road nameâ€¦" oninput="renderSidebar()"/>
        <i class="fas fa-search"></i>
      </div>
    </div>

    <!-- Road List -->
    <div class="road-list-wrap" id="road-list"></div>
  </div>

  <!-- â”€â”€ Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="map-wrap">
    <div id="map"></div>

    <!-- View Toggle -->
    <div class="view-toggle">
      <button class="vt-btn active" id="vt-markers" onclick="switchView('markers')"><i class="fas fa-map-marker-alt me-1"></i>Markers</button>
      <button class="vt-btn" id="vt-cluster" onclick="switchView('cluster')"><i class="fas fa-circle-nodes me-1"></i>Cluster</button>
      <button class="vt-btn" id="vt-heat" onclick="switchView('heat')"><i class="fas fa-fire me-1"></i>Heat</button>
      <button class="vt-btn" id="vt-route" onclick="switchView('route')"><i class="fas fa-route me-1"></i>Route</button>
    </div>

    <!-- FAB controls -->
    <div class="map-fab-group">
      <div style="position:relative">
        <button class="map-fab" onclick="locateMe()" title="My Location"><i class="fas fa-location-crosshairs"></i></button>
      </div>
      <div style="position:relative">
        <button class="map-fab" onclick="fitAllMarkers()" title="Fit all markers"><i class="fas fa-compress-arrows-alt"></i></button>
      </div>
      <div style="position:relative">
        <button class="map-fab" id="fab-legend" onclick="toggleLegend()" title="Legend"><i class="fas fa-circle-info"></i></button>
      </div>
      <div style="position:relative">
        <button class="map-fab" onclick="exportMapPNG()" title="Screenshot map"><i class="fas fa-camera"></i></button>
      </div>
      <div style="position:relative">
        <button class="map-fab" onclick="cycleBasemap()" title="Change map style" id="fab-basemap"><i class="fas fa-layer-group"></i></button>
      </div>
    </div>

    <!-- Live pill -->
    <div class="live-pill">
      <span class="live-dot"></span>
      <span id="live-text">Live Â· <span id="map-count">0</span> roads</span>
    </div>

    <!-- Stats strip -->
    <div class="stats-strip">
      <div class="stat-pill">
        <div class="sp-val" id="strip-health">â€”</div>
        <div class="sp-lbl">City Score</div>
      </div>
      <div class="stat-pill">
        <div class="sp-val" id="strip-eco">â€”</div>
        <div class="sp-lbl">30d Risk</div>
      </div>
    </div>

    <!-- Route Playback Controls -->
    <div class="route-panel" id="route-panel">
      <button class="rp-btn" onclick="playbackPrev()"><i class="fas fa-step-backward"></i></button>
      <button class="rp-btn" id="rp-play" onclick="togglePlayback()"><i class="fas fa-play"></i></button>
      <button class="rp-btn" onclick="playbackNext()"><i class="fas fa-step-forward"></i></button>
      <span id="rp-label" style="min-width:140px;text-align:center">Select a road</span>
      <button class="rp-btn" onclick="stopRoute()" style="margin-left:4px"><i class="fas fa-times"></i></button>
    </div>

    <!-- Legend -->
    <div class="map-legend" id="map-legend">
      <div style="font-weight:700;margin-bottom:8px;font-size:.75rem">Severity Legend</div>
      <div class="legend-row"><span class="legend-dot" style="background:#7b0000"></span>Emergency (8â€“10)</div>
      <div class="legend-row"><span class="legend-dot" style="background:#dc3545"></span>Critical (6â€“8)</div>
      <div class="legend-row"><span class="legend-dot" style="background:#fd7e14"></span>Severe (4â€“6)</div>
      <div class="legend-row"><span class="legend-dot" style="background:#ffc107"></span>Moderate (2â€“4)</div>
      <div class="legend-row"><span class="legend-dot" style="background:#28a745"></span>Good (0â€“2)</div>
      <hr style="border-color:rgba(255,255,255,.15);margin:8px 0"/>
      <div style="font-size:.68rem;color:rgba(255,255,255,.5)">Marker size = severity<br>Pulse = Emergency road</div>
    </div>
  </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAP INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BASEMAPS = [
  { name:"Dark",   url:"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png" },
  { name:"Light",  url:"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png" },
  { name:"Street", url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" },
  { name:"Satellite", url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}" },
];
let basemapIdx = 0;

const map = L.map("map", { zoomControl:false, attributionControl:false })
              .setView([17.6868, 75.9079], 13);

let tileLayer = L.tileLayer(BASEMAPS[0].url, {subdomains:"abcd",maxZoom:22}).addTo(map);
L.control.zoom({position:"bottomright"}).addTo(map);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allData       = [];
let currentView   = "markers";
let currentFilter = "";
let activeItem    = null;
let heatLayer     = null;
let markersGroup  = L.layerGroup().addTo(map);
let routeGroup    = L.layerGroup().addTo(map);
let userMarker    = null;

// Route playback state
let routePoints   = [];
let routeIdx      = 0;
let routePlaying  = false;
let routeTimer    = null;
let routeMarker   = null;
let routePolyline = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ICON FACTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeIcon(color, score, isPulse) {
  const s = score >= 8 ? 32 : score >= 6 ? 26 : score >= 4 ? 20 : 16;
  const pulse = isPulse ? `
    <div style="position:absolute;width:${s+12}px;height:${s+12}px;border-radius:50%;
      border:2px solid ${color};top:${-6}px;left:${-6}px;animation:pulse-ring 2s infinite;opacity:.5"></div>` : "";
  const html = `
    <div style="position:relative;width:${s}px;height:${s}px">
      ${pulse}
      <div style="width:${s}px;height:${s}px;border-radius:50%;background:${color};
        border:3px solid rgba(255,255,255,.7);box-shadow:0 0 14px ${color}99,0 2px 8px rgba(0,0,0,.3);
        display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:${Math.max(8,s*0.35)}px">
        ${score >= 6 ? "!" : ""}
      </div>
    </div>`;
  return L.divIcon({html, iconSize:[s,s], iconAnchor:[s/2,s/2], className:""});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POPUP FACTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SEV_COLORS = {Good:"#28a745",Moderate:"#ffc107",Severe:"#fd7e14",Critical:"#dc3545",Emergency:"#7b0000"};
const TYPE_BG    = {"Pothole":"#e94560","Alligator Crack":"#fd7e14","Transverse Crack":"#0f3460","Longitudinal Crack":"#28a745"};

function fmtEco(v) {
  if (!v) return "â‚¹0";
  return v >= 10000000 ? "â‚¹"+(v/10000000).toFixed(1)+"Cr" : v >= 100000 ? "â‚¹"+(v/100000).toFixed(1)+"L" : "â‚¹"+v.toLocaleString("en-IN");
}
function fmtDate(ts) { return ts ? ts.replace("T"," ").substring(0,16) : "â€”"; }

function buildPopup(d) {
  const color = d.color || SEV_COLORS[d.level] || "#888";
  const typesHTML = (d.all_detections||[]).map(t =>
    `<span class="pop-type-chip" style="background:${TYPE_BG[t.label]||'#888'}">${t.label}Ã—${t.count}</span>`
  ).join("") || '<span style="color:#aaa;font-size:.72rem">No damage types</span>';

  const routePts = d.route_points || [];
  const hasRoute = routePts.length > 1;

  return `<div class="rs-popup">
    <div class="pop-header">
      <div class="pop-road">ğŸ“ ${d.road_name}</div>
      <span class="pop-score" style="background:${color}">${d.score}/10 â€” ${d.level}</span>
    </div>
    <div class="pop-row"><span class="pop-key">Frames Captured</span><span class="pop-val">${d.frames_captured||1}</span></div>
    <div class="pop-row"><span class="pop-key">Defect Frames</span><span class="pop-val" style="color:#e94560">${d.defect_frames||0}</span></div>
    <div class="pop-row"><span class="pop-key">Economic Risk/30d</span><span class="pop-val" style="color:#e94560">${fmtEco(d.economic_impact)}</span></div>
    <div class="pop-row"><span class="pop-key">Required Action</span><span class="pop-val">${d.repair_action||"â€”"}</span></div>
    <div class="pop-row"><span class="pop-key">Inspected By</span><span class="pop-val">${d.officer||"â€”"}</span></div>
    <div class="pop-row"><span class="pop-key">Date / Time</span><span class="pop-val">${d.inspection_date||""} ${d.inspection_time||""}</span></div>
    <div class="pop-row"><span class="pop-key">GPS</span><span class="pop-val" style="font-size:.7rem;font-family:monospace">${(d.lat||0).toFixed(5)}, ${(d.lng||0).toFixed(5)}</span></div>
    <div class="pop-types">${typesHTML}</div>
    ${d.annotated_img ? `<img class="pop-img" src="${d.annotated_img}" onerror="this.style.display='none'" alt="Detection"/>` : ""}
    <div class="pop-actions">
      <a href="/api/report/${d.id}" target="_blank" class="pop-btn" style="background:#e94560;color:#fff"><i class="fas fa-file-pdf me-1"></i>PDF</a>
      ${hasRoute ? `<button class="pop-btn" style="background:#0f3460;color:#fff" onclick="showRoute(${JSON.stringify(routePts).replace(/"/g,'&quot;')}, '${d.road_name}')"><i class="fas fa-route me-1"></i>Route</button>` : ""}
      <button class="pop-btn" style="background:#f0f2f5;color:#1a1a2e" onclick="map.closePopup()">Close</button>
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMarkers(data) {
  markersGroup.clearLayers();
  data.forEach(d => {
    const color   = d.color || SEV_COLORS[d.level] || "#888";
    const isPulse = d.score >= 8;
    const marker  = L.marker([d.lat, d.lng], {icon: makeIcon(color, d.score, isPulse)});
    marker.bindPopup(buildPopup(d), {maxWidth:300, className:"rs-popup-wrap"});
    marker.on("click", () => highlightSidebarItem(d.id));
    markersGroup.addLayer(marker);
  });
}

function renderCluster(data) {
  // Simple cluster: group points within ~0.01 degrees
  markersGroup.clearLayers();
  const clusters = {};
  data.forEach(d => {
    const key = `${(d.lat*100).toFixed(0)}_${(d.lng*100).toFixed(0)}`;
    if (!clusters[key]) clusters[key] = {items:[], lat:d.lat, lng:d.lng};
    clusters[key].items.push(d);
  });
  Object.values(clusters).forEach(c => {
    const worst = c.items.reduce((a,b) => a.score > b.score ? a : b);
    const color  = worst.color || SEV_COLORS[worst.level] || "#888";
    const count  = c.items.length;
    const size   = Math.min(50, 28 + count * 4);
    const html   = `<div style="width:${size}px;height:${size}px;border-radius:50%;background:${color};
      border:3px solid rgba(255,255,255,.7);box-shadow:0 0 14px ${color}88;
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:${Math.max(10,size*0.35)}px">
      ${count > 1 ? count : "!"}</div>`;
    const m = L.marker([c.lat, c.lng], {icon: L.divIcon({html, iconSize:[size,size], iconAnchor:[size/2,size/2], className:""})});
    m.bindPopup(buildPopup(worst), {maxWidth:300});
    markersGroup.addLayer(m);
  });
}

function renderHeat(data) {
  if (heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }
  markersGroup.clearLayers();
  const pts = data.map(d => [d.lat, d.lng, Math.min(1, d.score / 10)]);
  heatLayer = L.heatLayer(pts, {
    radius: 35, blur: 25, maxZoom: 17,
    gradient: {0.0:"#28a745", 0.25:"#ffc107", 0.5:"#fd7e14", 0.75:"#dc3545", 1.0:"#7b0000"}
  }).addTo(map);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROUTE VIEW â€” shows the actual drive path
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRoutes(data) {
  markersGroup.clearLayers();
  routeGroup.clearLayers();
  data.forEach(d => {
    const pts = d.route_points || [];
    if (pts.length < 2) {
      // Single point â€” just marker
      const color = d.color || "#888";
      const m = L.marker([d.lat, d.lng], {icon: makeIcon(color, d.score, d.score >= 8)});
      m.bindPopup(buildPopup(d), {maxWidth:300});
      markersGroup.addLayer(m);
      return;
    }
    // Draw route line colored by per-point severity
    const latlngs = pts.map(p => [p.lat, p.lng]);
    const lineColor = d.color || SEV_COLORS[d.level] || "#888";
    const poly = L.polyline(latlngs, {
      color: lineColor, weight: 5, opacity: 0.8,
      dashArray: d.score < 4 ? "8,6" : null
    });
    poly.bindPopup(buildPopup(d), {maxWidth:300});
    routeGroup.addLayer(poly);

    // Start/end markers
    L.circleMarker(latlngs[0], {radius:5, fillColor:"#28a745", color:"#fff", weight:2, fillOpacity:1})
      .bindTooltip("Start: "+d.road_name).addTo(routeGroup);
    L.circleMarker(latlngs[latlngs.length-1], {radius:5, fillColor:lineColor, color:"#fff", weight:2, fillOpacity:1})
      .bindTooltip("End: "+d.road_name).addTo(routeGroup);

    // Defect dots along the route
    pts.forEach(p => {
      if (p.score >= 4) {
        const c = p.score >= 8 ? "#7b0000" : p.score >= 6 ? "#dc3545" : "#fd7e14";
        L.circleMarker([p.lat, p.lng], {radius:4, fillColor:c, color:"#fff", weight:1.5, fillOpacity:1})
          .addTo(routeGroup);
      }
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROUTE PLAYBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showRoute(pts, name) {
  map.closePopup();
  switchView("route");
  routePoints = pts;
  routeIdx    = 0;
  document.getElementById("route-panel").classList.add("show");
  document.getElementById("rp-label").textContent = name + " â€” Point 0/" + pts.length;
  updateRouteMarker();
}

function updateRouteMarker() {
  if (!routePoints.length) return;
  const p = routePoints[routeIdx];
  if (!p) return;
  if (routeMarker) routeGroup.removeLayer(routeMarker);
  const score = p.score || 0;
  const color = score >= 8 ? "#7b0000" : score >= 6 ? "#dc3545" : score >= 4 ? "#fd7e14" : "#28a745";
  routeMarker = L.marker([p.lat, p.lng], {icon: L.divIcon({
    html:`<div style="width:20px;height:20px;border-radius:50%;background:${color};border:3px solid #fff;box-shadow:0 0 10px ${color}"></div>`,
    iconSize:[20,20], iconAnchor:[10,10], className:""
  })}).addTo(routeGroup);
  map.setView([p.lat, p.lng], 17, {animate:true});
  document.getElementById("rp-label").textContent =
    `${document.getElementById("rp-label").textContent.split("â€”")[0]}â€” Pt ${routeIdx+1}/${routePoints.length} Â· Score ${score}/10`;
}

function playbackNext() { if (routeIdx < routePoints.length-1) { routeIdx++; updateRouteMarker(); } }
function playbackPrev() { if (routeIdx > 0) { routeIdx--; updateRouteMarker(); } }
function togglePlayback() {
  routePlaying = !routePlaying;
  document.getElementById("rp-play").innerHTML = routePlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
  if (routePlaying) {
    routeTimer = setInterval(() => {
      if (routeIdx >= routePoints.length - 1) { togglePlayback(); return; }
      routeIdx++; updateRouteMarker();
    }, 800);
  } else {
    clearInterval(routeTimer);
  }
}
function stopRoute() {
  clearInterval(routeTimer); routePlaying = false; routePoints = []; routeIdx = 0;
  if (routeMarker) { routeGroup.removeLayer(routeMarker); routeMarker = null; }
  document.getElementById("route-panel").classList.remove("show");
  document.getElementById("rp-play").innerHTML = '<i class="fas fa-play"></i>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VIEW SWITCHER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchView(v) {
  currentView = v;
  ["vt-markers","vt-cluster","vt-heat","vt-route"].forEach(id =>
    document.getElementById(id).classList.remove("active")
  );
  document.getElementById("vt-"+v).classList.add("active");
  if (heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }
  routeGroup.clearLayers();
  markersGroup.clearLayers();
  const filtered = getFiltered();
  if (v === "markers")  renderMarkers(filtered);
  else if (v==="cluster") renderCluster(filtered);
  else if (v==="heat")  renderHeat(filtered);
  else if (v==="route") renderRoutes(filtered);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSidebar() {
  const q    = (document.getElementById("road-search").value||"").toLowerCase();
  let data   = getFiltered();
  if (q) data = data.filter(d => d.road_name.toLowerCase().includes(q));
  data = data.slice().sort((a,b) => b.score - a.score);

  const list = document.getElementById("road-list");
  document.getElementById("sidebar-count") && (document.getElementById("sidebar-count").textContent = data.length);

  if (!data.length) {
    list.innerHTML = `<div style="text-align:center;padding:40px 16px;color:#aaa;font-size:.82rem">
      <i class="fas fa-search" style="font-size:2rem;margin-bottom:12px;display:block;opacity:.3"></i>
      No roads found.</div>`;
    return;
  }
  list.innerHTML = data.map(d => {
    const color = d.color || SEV_COLORS[d.level] || "#888";
    const eco   = fmtEco(d.economic_impact);
    const hasRoute = (d.route_points||[]).length > 1;
    return `<div class="road-item" id="ri-${d.id}" onclick="clickRoadItem(event,'${d.id}',${d.lat},${d.lng})">
      <div class="ri-score" style="background:${color}">${d.score}</div>
      <div class="ri-info">
        <div class="ri-name">${d.road_name}</div>
        <div class="ri-meta">${d.inspection_date||""} Â· ${d.source||""} ${hasRoute?"Â· ğŸ›£ route":""}</div>
        <div class="ri-eco">${eco}/30d</div>
      </div>
      <span class="ri-badge" style="background:${color}">${d.level}</span>
    </div>`;
  }).join("");
}

function clickRoadItem(e, id, lat, lng) {
  const d = allData.find(x => x.id === id);
  if (!d) return;
  map.flyTo([lat, lng], 17, {duration:1.2});
  setTimeout(() => {
    const marker = findMarkerForData(d);
    if (marker) marker.openPopup();
    else L.popup({maxWidth:300}).setLatLng([lat,lng]).setContent(buildPopup(d)).openOn(map);
  }, 1300);
  highlightSidebarItem(id);
}

function findMarkerForData(d) {
  let found = null;
  markersGroup.eachLayer(m => {
    if (m.getLatLng && m.getLatLng().lat === d.lat && m.getLatLng().lng === d.lng) found = m;
  });
  return found;
}

function highlightSidebarItem(id) {
  document.querySelectorAll(".road-item").forEach(el => el.classList.remove("active-item"));
  const el = document.getElementById("ri-"+id);
  if (el) { el.classList.add("active-item"); el.scrollIntoView({behavior:"smooth",block:"nearest"}); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFilter(btn, level) {
  currentFilter = level;
  document.querySelectorAll(".fchip").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  refreshAll();
}
function getFiltered() {
  return currentFilter ? allData.filter(d => d.level === currentFilter) : allData;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCORE RING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateScoreRing(score, stats) {
  const r   = 22, circ = 2 * Math.PI * r;
  const pct = Math.max(0, Math.min(100, score));
  const offset = circ - (pct / 100) * circ;
  const color = pct >= 70 ? "#28a745" : pct >= 50 ? "#ffc107" : pct >= 30 ? "#fd7e14" : "#dc3545";

  const fill = document.getElementById("score-ring-fill");
  fill.style.strokeDashoffset = offset;
  fill.style.stroke = color;
  document.getElementById("score-ring-num").textContent = pct;
  document.getElementById("strip-health").textContent = pct+"/100";

  document.getElementById("ss-total").textContent = stats.total || 0;
  document.getElementById("ss-crit").textContent  = stats.critical || 0;
  document.getElementById("ss-emerg").textContent = stats.emergency || 0;
  const eco = stats.economic_risk || 0;
  document.getElementById("ss-eco").textContent   = fmtEco(eco);
  document.getElementById("strip-eco").textContent = fmtEco(eco);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOCATE ME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function locateMe() {
  if (!navigator.geolocation) { alert("Geolocation not supported."); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    map.flyTo([lat, lng], 16, {duration:1.5});
    if (userMarker) map.removeLayer(userMarker);
    userMarker = L.marker([lat, lng], {icon: L.divIcon({
      html:`<div style="width:18px;height:18px;border-radius:50%;background:#0f3460;border:3px solid #fff;box-shadow:0 0 12px #0f3460"></div>`,
      iconSize:[18,18], iconAnchor:[9,9], className:""
    })}).bindPopup("ğŸ“ Your Location").addTo(map).openPopup();
  }, () => alert("Could not get your location."));
}

function fitAllMarkers() {
  const pts = allData.filter(d => d.lat && d.lng).map(d => [d.lat, d.lng]);
  if (pts.length) map.fitBounds(L.latLngBounds(pts).pad(0.15));
}

function toggleLegend() {
  document.getElementById("map-legend").classList.toggle("show");
  document.getElementById("fab-legend").classList.toggle("active");
}

function cycleBasemap() {
  basemapIdx = (basemapIdx + 1) % BASEMAPS.length;
  map.removeLayer(tileLayer);
  tileLayer = L.tileLayer(BASEMAPS[basemapIdx].url, {subdomains:"abcd",maxZoom:22}).addTo(map);
  tileLayer.bringToBack();
}

function exportMapPNG() {
  alert("To save the map, press Ctrl+Shift+I â†’ Network â†’ reload page, or use your browser Print function (Ctrl+P) and save as PDF.");
}

function togglePanel() {
  const panel  = document.getElementById("map-panel");
  const toggle = document.getElementById("panel-toggle");
  const icon   = document.getElementById("panel-toggle-icon");
  panel.classList.toggle("collapsed");
  toggle.classList.toggle("collapsed");
  icon.className = panel.classList.contains("collapsed") ? "fas fa-chevron-right" : "fas fa-chevron-left";
  toggle.style.left = panel.classList.contains("collapsed") ? "0px" : "320px";
  setTimeout(() => map.invalidateSize(), 310);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshAll() {
  const filtered = getFiltered();
  if      (currentView === "markers") renderMarkers(filtered);
  else if (currentView === "cluster") renderCluster(filtered);
  else if (currentView === "heat")    renderHeat(filtered);
  else if (currentView === "route")   renderRoutes(filtered);
  renderSidebar();
}

function loadData() {
  Promise.all([
    fetch("/api/heatmap-data").then(r => r.json()),
    fetch("/api/stats").then(r => r.json()),
  ]).then(([heatData, stats]) => {
    allData = heatData;
    document.getElementById("map-count").textContent = heatData.length;
    document.getElementById("last-update-text").textContent = "Updated " + new Date().toLocaleTimeString();
    updateScoreRing(stats.city_health || 100, stats);
    refreshAll();
  }).catch(console.error);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Add pulse ring CSS
const style = document.createElement("style");
style.textContent = `
  @keyframes pulse-ring { 0%{transform:scale(1);opacity:.6} 70%{transform:scale(1.8);opacity:0} 100%{transform:scale(1.8);opacity:0} }
  .rs-popup-wrap .leaflet-popup-content-wrapper { border-radius:10px; padding:0; overflow:hidden; }
  .rs-popup-wrap .leaflet-popup-content { margin:14px 20px; }
`;
document.head.appendChild(style);

loadData();
setInterval(loadData, 15000);
</script>
{% endblock %}